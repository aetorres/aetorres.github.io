<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1 maximum-scale=1; minimum-scale=1; user-scalable=no;"> <meta content="3 Steps (2 minutes) to Setup Your Personal Website with Jalpc" name="description"> <meta name="keywords" content="Jalpc,Jekyll,gh-pages,website,blog,easy"> <meta name="author" content="Andres Torres"> <meta name="baseurl" content="/homepage"> <title> Andres Site|How to delete Spot Instances using a Lambda function </title> <!-- favicon --> <link rel="shortcut icon" href="/homepage/static/assets/img/favicon.ico"> <!-- Main CSS --> <link href="/homepage/static/assets/app-20180125.min.css" rel="stylesheet"> <link href="/homepage/static/css/custom.css" rel="stylesheet"> <!-- Main Scripts --> <script src="/homepage/static/assets/app-20180125.min.js"></script> <script src="/homepage/static/assets/blog-20180125.min.js"></script> <!-- Google AdSense --> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script> (adsbygoogle = window.adsbygoogle || []).push({ google_ad_client: "ca-pub-6196184668650108", enable_page_level_ads: true }); </script> </head> <body id="page-top" class="landing-page"> <div class="search-tool" style="position: fixed; top: 0px ; bottom: 0px; left: 0px; right: 0px; opacity: 0.95; background-color: #111111; z-index: 9999; display: none;"> <input type="text" class="form-control search-content" id="search-content" style="position: fixed; top: 60px" placeholder="Search Blog"> <div style="position: fixed; top: 16px; right: 16px; z-index: 9999;"> <img src="/homepage/static/assets/img/search/cb-close.png" id="close-btn"/> </div> </div> <div style="position: fixed; right: 16px; bottom: 20px; z-index: 9999;"> <img src="/homepage/static/assets/img/search/cb-search.png" id="search-btn" title="Double click Ctrl"/> </div> <div class="navbar-wrapper"> <nav class="navbar navbar-default navbar-fixed-top" role="navigation"> <div class="container"> <div class="navbar-header page-scroll"> <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/homepage/">Andres Site</a> </div> <div id="navbar" class="navbar-collapse collapse"> <ul class="nav navbar-nav navbar-right"> <li><a class="page-scroll" href="/homepageblog/"></a></li> <li> <a class="page-scroll" href="/homepage/blog/">Blog</a></li> <li> <a class="page-scroll" href="/homepage/aws/">AWS</a></li> <li> <a class="page-scroll" href="/homepage/linux/">Linux</a></li> <li> <a class="page-scroll" href="/homepage/jenkins/">Jenkins</a></li> <li> <a class="page-scroll" href="/homepage/docker/">Docker</a></li> <li> <a class="page-scroll" href="/homepage/vagrant/">Vagrant</a></li> <li> <a class="page-scroll" href="/homepage/chef/">Chef</a></li> <li> <a class="page-scroll" href="/homepage/terraform/">Terraform</a></li> <li> <a class="page-scroll" href="/homepage/ansible/">Ansible</a></li> <li> <a class="page-scroll" href="/homepage/life/">Others</a></li> </ul> </div> </div> </nav> </div> <div id="inSlider" class="carousel carousel-fade" data-ride="carousel"> <ol class="carousel-indicators"> <li data-target="#inSlider" data-slide-to="0" class="active"></li> <li data-target="#inSlider" data-slide-to="1"></li> </ol> <div class="carousel-inner" role="listbox"> <div class="item active"> <div class="container"> <div class="carousel-caption"> </div> <div class="carousel-image wow zoomIn"> <!-- <img src="static/img/landing/laptop.png" alt="laptop"/> --> </div> </div> <!-- Set background for slide in css --> <div class="header-back" style="background-image: url(/homepage/static/assets/img/landing/prog.jpg);" title="first banner image"> </div> </div> <div class="item"> <div class="container"> <div class="carousel-caption"> </div> <div class="carousel-image wow zoomIn"> <!-- <img src="static/img/landing/laptop.png" alt="laptop"/> --> </div> </div> <!-- Set background for slide in css --> <div class="header-back" style="background-image: url(/homepage/static/assets/img/landing/prog2.jpg);" title="2nd banner image"></div> </div> <div class="item"> <div class="container"> <div class="carousel-caption"> </div> <div class="carousel-image wow zoomIn"> <!-- <img src="static/img/landing/laptop.png" alt="laptop"/> --> </div> </div> <!-- Set background for slide in css --> <div class="header-back" style="background-image: url(/homepage/static/assets/img/landing/prog3.jpg);" title="3rd banner image"></div> </div> <div class="item"> <div class="container"> <div class="carousel-caption"> </div> <div class="carousel-image wow zoomIn"> <!-- <img src="static/img/landing/laptop.png" alt="laptop"/> --> </div> </div> <!-- Set background for slide in css --> <div class="header-back" style="background-image: url(/homepage/static/assets/img/landing/prog6.jpg);" title="4th banner image"></div> </div> </div> <a class="left carousel-control" href="#inSlider" role="button" data-slide="prev"> <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span> <span class="sr-only">Previous</span> </a> <a class="right carousel-control" href="#inSlider" role="button" data-slide="next"> <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span> <span class="sr-only">Next</span> </a> </div> <div class="wrapper wrapper-content animated fadeInRight article"> <div class="row"> <div class="col-lg-10 col-lg-offset-1"> <div class="ibox"> <div class="ibox-content"> <div class="pull-right"> <a class="btn btn-white btn-xs" href="/homepage/aws">AWS</a> </div> <div class="text-center article-title"> <span class="text-muted"><i class="fa fa-clock-o"></i> 20 Jun 2018</span> <h1> How to delete Spot Instances using a Lambda function </h1> </div> <p>I know, almost everybody knows how to delete instances using lambda functions, but, there are a little difference between a <code class="highlighter-rouge">regular EC2 instance</code> and <code class="highlighter-rouge">spot instaces</code>. In this case, letâ€™s say that the <code class="highlighter-rouge">spot instances</code> are slaves or workers for the <code class="highlighter-rouge">EC2 instances</code>.</p> <p>You would need to use some additional libraries if you want this script works, those libraries are not isntalled by default on AWS, thats why you would need to build this script locally ( on your PC) before push it to AWS.</p> <p>Those libraries are <code class="highlighter-rouge">pytz</code> and <code class="highlighter-rouge">datetime</code>.</p> <p>I just added a small script that will install those libraries and compress the whole code before push it to AWS.</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c">#!/usr/bin/env bash</span>

pip <span class="nb">install</span> <span class="nt">-t</span> <span class="nb">.</span> pytz
pip <span class="nb">install</span> <span class="nt">-t</span> <span class="nb">.</span> datetime
pip <span class="nb">install</span> <span class="nt">-t</span> <span class="nb">.</span> logging
zip <span class="nt">-r</span> lamda.zip <span class="nb">.</span>

</code></pre></div></div> <p>As you can se we look for all the spot instances that has been fulfilled ( created and running ), otherwise it will fail with cancelled instances or terminated instances; also you can tell that we will terminate those <code class="highlighter-rouge">spot intances</code> that have been working by more than 10h one by one.</p> <div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>import boto3
import logging
from datetime import datetime
from datetime import timedelta
from pytz import timezone
logger = logging.getLogger()
logger.setLevel(logging.DEBUG)




def lambda_handler(event, context):
    client = boto3.client('ec2')
    instances = client.describe_spot_instance_requests(Filters=[{'Name': 'status-code','Values': ['fulfilled']}] )
    est = timezone('&lt;AZ timezone&gt;')
    print est.localize(datetime.now())
    instance=[]
    for r in instances['SpotInstanceRequests']:
        print r['InstanceId']
        print r['Status']['UpdateTime']
        if r["CreateTime"] &lt; est.localize(datetime.now() - timedelta(hours=10)):
            print "Instance Terminated Due more than 10h from creation time"
            instance.append(r['InstanceId'])
            client.terminate_instances( DryRun=False, InstanceIds=instance )
        else:
            print "Instance OK"
    return 1


</code></pre></div></div> <hr> <div class="row"> <div class="col-md-6"> <h5 style="display: inline;">Tags:</h5> <button class="btn btn-white btn-xs" type="button">lambda</button> <button class="btn btn-white btn-xs" type="button">AWS</button> <button class="btn btn-white btn-xs" type="button">Python</button> </div> <div class="col-md-6"> <div class="small text-right"> <div> </div> </div> </div> </div> <br> <div class="row"> <div class="col-lg-12"> <!-- donate --> <br> <!-- share --> <div class="a2a_kit a2a_kit_size_32 a2a_default_style"> <a class="a2a_dd" href="https://www.addtoany.com/share"></a> <a class="a2a_button_facebook"></a> <a class="a2a_button_twitter"></a> <a class="a2a_button_google_plus"></a> <a class="a2a_button_linkedin"></a> <a class="a2a_button_email"></a> <a class="a2a_button_wechat"></a> <a class="a2a_button_sina_weibo"></a> <a class="a2a_button_pocket"></a> </div> <script> var a2a_config = a2a_config || {}; a2a_config.color_main = "D7E5ED"; a2a_config.color_border = "AECADB"; a2a_config.color_link_text = "333333"; a2a_config.color_link_text_hover = "333333"; </script> <script async src="https://static.addtoany.com/menu/page.js"></script> <br> <!-- comment --> </div> </div> </div> </div> </div> </div> </div> <!-- Google analytics --> <!-- GrowingIO --> </body> </html>
